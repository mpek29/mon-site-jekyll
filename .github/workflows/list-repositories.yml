name: List Repositories

on:
  push:
    branches:
      - master  # Trigger workflow on push to the master branch
  workflow_dispatch:  # Allow manual execution of the workflow

jobs:
  list_repositories:
    runs-on: ubuntu-latest

    steps:
    # Checkout the repository code
    - name: Checkout code
      uses: actions/checkout@v2

    # Fetch the list of repositories with names, descriptions, and URLs
    - name: Store repositories in a variable
      id: list_repositories
      run: |
        echo "Fetching repository list..."
        
        # RÃ©cupÃ©rer les donnÃ©es via l'API GitHub
        REPOS_JSON=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                            -H "Accept: application/vnd.github.v3+json" \
                            https://api.github.com/users/mpek29/repos?type=all)
        
        # VÃ©rifier si la rÃ©ponse de l'API contient une erreur
        if echo "$REPOS_JSON" | jq -e 'has("message")' > /dev/null; then
          echo "âŒ Erreur lors de la rÃ©cupÃ©ration des repos :"
          echo "$REPOS_JSON"
          exit 1
        fi

        # Transformer en liste de dictionnaires (nom + description + lien)
        REPOS_LIST=$(echo "$REPOS_JSON" | jq -c '[.[] | {title: .name, description: (.description // "No description available"), url: .html_url}]')

        # VÃ©rifier si la liste est vide
        if [ -z "$REPOS_LIST" ] || [ "$REPOS_LIST" == "[]" ]; then
          echo "âŒ Aucun dÃ©pÃ´t trouvÃ© pour l'utilisateur mpek29."
          exit 1
        fi

        # Stocker dans une variable d'environnement
        echo "REPOS_LIST=$REPOS_LIST" >> $GITHUB_ENV

    # Download images from each repository
    - name: Download repository images
      run: |
        echo "Downloading images from each repository..."
        mkdir -p assets/img/projects  # CrÃ©er le dossier parent s'il n'existe pas

        # Parcourir la liste des repos et tÃ©lÃ©charger les images
        echo "$REPOS_LIST" | jq -c '.[]' | while read -r repo; do
          title=$(echo "$repo" | jq -r '.title')

          # Ignorer les dÃ©pÃ´ts "MPek29", "en" et "mon-site-jekyll"
          if [ "$title" == "MPek29" ] || [ "$title" == "en" ] || [ "$title" == "mon-site-jekyll" ] || [ "$title" == "mpek29.github.io" ]; then
            echo "âš ï¸ DÃ©pÃ´t '$title' ignorÃ©."
            continue
          fi

          repo_url=$(echo "$repo" | jq -r '.url')
          repo_name=$(basename "$repo_url")  # RÃ©cupÃ©rer uniquement le nom du repo

          # DÃ©finir l'URL de l'API GitHub pour rÃ©cupÃ©rer le contenu du dossier
          API_URL="https://api.github.com/repos/mpek29/$repo_name/contents/assets/img"

          # RÃ©cupÃ©rer la liste des fichiers
          FILES_JSON=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                              -H "Accept: application/vnd.github.v3+json" "$API_URL")

          # VÃ©rifier si la rÃ©ponse est un tableau (dossier valide)
          if echo "$FILES_JSON" | jq -e 'if type == "array" then true else false end' > /dev/null; then
            # CrÃ©er le dossier de destination
            DEST_FOLDER="assets/img/projects/$title"
            mkdir -p "$DEST_FOLDER"

            # Supprimer les anciennes images dans le dossier de destination
            rm -rf "$DEST_FOLDER/*"  # Remove existing images

            # TÃ©lÃ©charger chaque image
            echo "$FILES_JSON" | jq -r '.[] | select(.type == "file") | .download_url' | while read -r file_url; do
              echo "ðŸ“¥ TÃ©lÃ©chargement : $file_url"
              wget -q -P "$DEST_FOLDER" "$file_url"
            done

            echo "âœ… Images enregistrÃ©es dans $DEST_FOLDER"
          else
            echo "âš ï¸ Pas d'images trouvÃ©es pour $title, il sera ignorÃ©."
          fi
        done

    # Create Markdown files for each repository in the _projects folder
    - name: Create Markdown files
      run: |
        echo "Creating Markdown files for each repository..."
        mkdir -p _projects  # CrÃ©er le dossier _projects s'il n'existe pas

        # Lire la liste de dictionnaires et gÃ©nÃ©rer les fichiers Markdown
        echo "$REPOS_LIST" | jq -c '.[]' | while read -r repo; do
          title=$(echo "$repo" | jq -r '.title')

          # Ignorer le dÃ©pÃ´t "MPek29"
          if [ "$title" == "MPek29" ]; then
            echo "âš ï¸ DÃ©pÃ´t 'MPek29' ignorÃ© pour la crÃ©ation des fichiers Markdown."
            continue
          fi

          description=$(echo "$repo" | jq -r '.description')
          url=$(echo "$repo" | jq -r '.url')  # RÃ©cupÃ©rer l'URL

          # VÃ©rifier que le titre n'est pas vide
          if [ -z "$title" ]; then
            echo "âš ï¸ Un dÃ©pÃ´t sans nom dÃ©tectÃ©, il sera ignorÃ©."
            continue
          fi

          # DÃ©finir le chemin de l'image principale (si disponible)
          img_path="assets/img/projects/$title/main.png"
          if [ ! -f "$img_path" ]; then
            img_path="assets/img/projects/default.png"  # Image par dÃ©faut si aucune image trouvÃ©e
          fi

          # PrÃ©parer le contenu Markdown
          markdown_content="---\n"
          markdown_content+="layout: page\n"
          markdown_content+="title: $title\n"
          markdown_content+="description: $description\n"
          markdown_content+="img: $img_path\n"
          markdown_content+="importance: 1\n"
          markdown_content+="git: $url\n"
          markdown_content+="category: 2025\n"
          markdown_content+="---\n\n"

          # Ã‰crire dans le fichier
          echo -e "$markdown_content" > "_projects/$title.md"
          echo "âœ… Created _projects/$title.md"
        done

    # Commit and push changes
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add _projects/*.md assets/img/projects/*
        git commit -m "Add Markdown files and images for repositories" || echo "No changes to commit"
        git push origin master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
